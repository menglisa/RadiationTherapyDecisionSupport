# Structure of the SQL Database for RTDS

Radiation Therapy Decision Support uses a SQL database to store extracted features and user / patient data for the website.
This document is designed to show the structure of the SQL database and what each table's headers mean on the database.

## Accessing a copy of the database. 

Go to [this link]() and download the database `dsrt.sql`. Alternatively, for the most bleeding-edge version of the 
server:
1) Log into the server
2) In the terminal prompt, type
```
$ mysqldump -u root -p ipilab dsrt > dsrt.sql
```
This will dump all the contents to `dsrt.sql`. 
3) Download `dsrt.sql` to your computer and delete it from the server.

To view the database, go to MySQL Workbench or similar, and perform a data import. This will import all the 
tables into a schema of your choice in naming (Note that schemas are like MySQL database- MySQL workbench just
uses a different name for them)

## Database Tables + Headers

#### `auth_group`
An `auth_group` is a set of permissions for all users given a specific group type.
For example, one row of the `auth_group` table might be `admins`, which we may have
users assigned to, for example, `admin1` and `admin2`. 

Headers:
id -> The unique id for the group. Used as a marker in other tables to signify a
        User's group.
name -> The name of the group, e.g. `admins`, `doctors`, etc. Note that in a multi-hospital
        setting this would need to also differentiate between doctors from different hospitals
        and such, so you may have `UCLA doctors`, `TUM doctors` and so on.

#### `auth_group_permissions`
This assigns the permissions to each `auth_group` based on the permission id in `auth_permission`.
For example, one row of the `auth_group_permissions` table might be to assign the `UCLA_doctors`
group the ability to read UCLA patient's data, marked by permission id 12.

Headers:
id -> unique ID for the permission
group_id -> The `auth_group` for whom the permission id should be granted
permission_id -> Specific permission by permission_id from `auth_permission`. 

#### `auth_permission`
This contains all the permission types available in RTDS. Examples include being able
to add or delete patients, beign able to add, change or delete groups and being able 
to view patient information.

Headers
id -> Unique ID for the permission
name -> Specific name of the permission. Follows naming `can [ACTION WORD] [VARIABLE TYPE]`,
        no uppercase
content_type_id -> id of the `[VARIABLE TYPE]` from the name. For example, all permissions 
        relating to `log_entry` may have `content_type_id` 1.
codename -> name without starting `can`

#### `auth_user`
This contains all the registered users for RTDS, including admins, doctors and clinicians.

Headers
id -> User's unique ID
password -> SHA 256 hashed password of user
last_login -> last time user logged in
is_superuser -> whether the user is an admin
username -> user's username
first_name -> user's first name
last_name -> user's last name
email -> user's email
is_staff -> whether user is a (developer of RTDS?)
is_active -> Whether the account has been deleted (unsure)
date_joined -> date of account creation

#### `auth_user_groups`
This links users by id to groups by id.

Headers
id -> id of linkage. Not really needed by anything.
user_id -> id of user from `auth_user`. 
group_id -> id of group from `auth_group` which the user identified
    by `user_id` should belong to. 

#### `auth_user_user_permissions`
This assigns permissions to user that are already not assigned from
the group.

Headers
id -> not really needed, id of linkage
user_id -> id of user from `auth_user`
permission_id -> id of permission from `auth_permission`

#### `patients`
This is basic patient metadata.

Headers
id -> database-assigned id for the patient. If two patients from different
        hospitals have the same `fk_user_id_id`, this should be used
        as the deciding factor as to which patient information belongs to. 
PatientName -> name of patient (full)
BirthDate -> Patient date of birth, `null` if not known
Gender -> Single character: `M` for Male, `F` for female, `O` for other
EnthicGroup -> Ethnic Group of patient, e.g. `White`, `Asian` etc
fk_user_id_id -> user id by hospital. Probably used as a unique patient
                identifier. Id is typically extracted from DICOM files
                for a patient.

#### `similarity`
This is used to store similarity values for the OVH, STS and target dose for 
a pair of patients. These values are generated by the Python scripts and 
stored here.

Headers
id -> not really needed, ID of similarity pair
DBStudyID -> The "Historical" patient in the pair. Typically at the time
    of this calculation, one of the patients is newly-uploaded, who is
    considered the current patient. The other patient in the pair is considered
    the historical patient. This is the study ID of the historical patient,
    from `studies`
Similarity -> Target Dose similarity (unsure)
OVHDissimilarity -> Similarity between two Overlap Volume Histograms for the two patients
STSDissimilarity -> Similarity between two Spatial Target Signature histograms
TargetOAR -> the OAR the OVH / STS are between, identified by id in `oar_dictionary`
fk_study_id_id -> the study ID of the current patient

#### `sts`



#### `studies`
This stores which study belongs to which patient. 

Headers
id -> database assigned id for the study
StudyInstanceUID -> from a DICOM file, what the study UID is
StudyDate -> Extracted from DICOM file with specified StudyInstanceUID
StudyDescription -> What the study scanned for 
TotalSeries -> unsure
fk_patient_id_id -> DICOM patient ID for whom the study belongs to. 
fk_user_id_id -> unsure. This should probably not exist

#### `userprofile_userprofile`
This is general user information on each person.

Headers
id -> not really needed, id of metadata
occupation -> occupation of user by id
institution -> place where the user works
birthday -> user date of birth
location -> location where the user works
bio -> biographical statement on the user. For example,
        one might write. "Dr. something, formerly worked at UCLA,
        now works at Roswell Park as a Radiation Oncologist"
user_id -> id for which the profile information belongs, user id from
            `auth_user`.



#### TODO: 
* Permission to access patient data by Hospital
* Set up initial auth_groups for `UCLA Doctor`, `UCLA admin`, and later on,
    `Roswell Park Doctor`, `Roswell Park Admin`.
* Add features on GUI to add first name, last name to account
* Add features on GUI to change email address or password. 
* Add features on GUI to retire account. Retiring the account should force
    the user to also re-assign all patients that are only assigned to one doctor,
    and should only be performable by an admin or developer.
* Add features on GUI to be able to assign permissions to a user (only should be visible
from admin login)
* Differentiation between developer, superuser, admin and user
    * Developers should be able to see all hospitals but not patient info
    * Superusers should be able to see all hospitals and patient info
    * admins should be able to see patient info only for their hospital (+ admin
        privileges should only apply to patients / users from their hospital)
    * users should also have privileges which apply only to their hospital
* Add column to `patients` table that identifies to which hospital they belong. This
    may need to be accompanied by a new table that links each hospital against a
    unique id. `userprofile` may also need to link institution then by hospital id. 
* Determine whether patient name should be split into first/last name fields.
* should we link studies in `studies` by database or DICOM patient ID? database patient
    ID seems less prone to errors. 
* Purpose of `fk_user_id_id` in `studies` table?